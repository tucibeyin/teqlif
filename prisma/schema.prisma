generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String         @id @default(cuid())
  name              String
  email             String         @unique
  password          String
  phone             String?
  avatar            String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  fcmToken          String?
  isVerified        Boolean        @default(false)
  resetCode         String?
  resetCodeExpires  DateTime?
  verifyCode        String?
  verifyCodeExpires DateTime?
  ads               Ad[]
  bids              Bid[]
  conversations1    Conversation[] @relation("User1Conversations")
  conversations2    Conversation[] @relation("User2Conversations")
  favorites         Favorite[]
  messages          Message[]
  notifications     Notification[]
}

model Category {
  id       String     @id @default(cuid())
  name     String
  slug     String     @unique
  icon     String?
  parentId String?
  ads      Ad[]
  parent   Category?  @relation("SubCategories", fields: [parentId], references: [id])
  children Category[] @relation("SubCategories")
}

model Province {
  id        String     @id
  name      String
  ads       Ad[]
  districts District[]
}

model District {
  id         String   @id
  name       String
  provinceId String
  ads        Ad[]
  province   Province @relation(fields: [provinceId], references: [id])
}

model Ad {
  id            String         @id @default(cuid())
  title         String
  description   String
  price         Float
  minBidStep    Float          @default(1)
  status        AdStatus       @default(ACTIVE)
  images        String[]
  expiresAt     DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  userId        String
  categoryId    String
  provinceId    String
  districtId    String
  startingBid   Float?
  views         Int            @default(0)
  isFixedPrice  Boolean        @default(false)
  buyItNowPrice Float?
  showPhone     Boolean        @default(false)
  category      Category       @relation(fields: [categoryId], references: [id])
  district      District       @relation(fields: [districtId], references: [id])
  province      Province       @relation(fields: [provinceId], references: [id])
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  bids          Bid[]
  conversations Conversation[]
  favorites     Favorite[]
  winnerId      String?
}

model Bid {
  id        String    @id @default(cuid())
  amount    Float
  createdAt DateTime  @default(now())
  userId    String
  adId      String
  status    BidStatus @default(PENDING)
  ad        Ad        @relation(fields: [adId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Conversation {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user1Id   String
  user2Id   String
  adId      String?
  ad        Ad?       @relation(fields: [adId], references: [id])
  user1     User      @relation("User1Conversations", fields: [user1Id], references: [id], onDelete: Cascade)
  user2     User      @relation("User2Conversations", fields: [user2Id], references: [id], onDelete: Cascade)
  messages  Message[]

  @@unique([user1Id, user2Id, adId])
}

model Message {
  id              String        @id @default(cuid())
  content         String
  isRead          Boolean       @default(false)
  createdAt       DateTime      @default(now())
  conversationId  String
  senderId        String
  conversation    Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender          User          @relation(fields: [senderId], references: [id], onDelete: Cascade)
  parentMessageId String?
  parentMessage   Message?      @relation("MessageReplies", fields: [parentMessageId], references: [id])
  replies         Message[]     @relation("MessageReplies")
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  message   String
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Favorite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String
  adId      String
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, adId])
}

enum NotificationType {
  BID_RECEIVED
  BID_ACCEPTED
  NEW_MESSAGE
  SYSTEM
}

enum AdStatus {
  ACTIVE
  SOLD
  EXPIRED
  DRAFT
}

enum BidStatus {
  PENDING
  ACCEPTED
  REJECTED
}
